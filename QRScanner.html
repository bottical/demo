<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診断機能付きQRコード検出アプリ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <style>
        #videoContainer, #canvasContainer {
            display: inline-block;
            margin-right: 10px;
        }
        canvas {
            border: 1px solid black;
        }
        #debug {
            margin-top: 20px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>診断機能付きQRコード検出アプリ</h1>
    <div id="videoContainer">
        <video id="video" width="320" height="240" autoplay></video>
    </div>
    <div id="canvasContainer">
        <canvas id="canvas" width="320" height="240"></canvas>
    </div>
    <div>
        <button id="captureButton">画像をキャプチャ</button>
        <button id="testQRButton">QRコード検出テスト</button>
    </div>
    <div id="debug"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const debugElement = document.getElementById('debug');
        const captureButton = document.getElementById('captureButton');
        const testQRButton = document.getElementById('testQRButton');

        // カメラの起動
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 640, height: 480 } })
            .then(function(stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
            })
            .catch(function(error) {
                console.error("カメラの起動に失敗しました:", error);
                debugElement.innerHTML += `カメラエラー: ${error.message}<br>`;
            });

        // 画像のキャプチャ
        captureButton.onclick = function() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            debugElement.innerHTML = "画像をキャプチャしました。<br>";
        };

        // QRコード検出テスト
        testQRButton.onclick = function() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            debugElement.innerHTML = `画像サイズ: ${canvas.width}x${canvas.height}<br>`;

            // グレースケール変換
            const grayData = new Uint8ClampedArray(imageData.width * imageData.height);
            for (let i = 0; i < imageData.data.length; i += 4) {
                grayData[i / 4] = (imageData.data[i] + imageData.data[i + 1] + imageData.data[i + 2]) / 3;
            }

            // グレースケール画像の表示
            const grayImageData = new ImageData(new Uint8ClampedArray(grayData.length * 4), imageData.width, imageData.height);
            for (let i = 0; i < grayData.length; i++) {
                grayImageData.data[i * 4] = grayData[i];
                grayImageData.data[i * 4 + 1] = grayData[i];
                grayImageData.data[i * 4 + 2] = grayData[i];
                grayImageData.data[i * 4 + 3] = 255;
            }
            ctx.putImageData(grayImageData, 0, 0);

            // QRコード検出
            const code = jsQR(grayData, imageData.width, imageData.height);

            if (code) {
                debugElement.innerHTML += `QRコード検出: データ "${code.data}"<br>`;
                debugElement.innerHTML += `位置: (${code.location.topLeftCorner.x}, ${code.location.topLeftCorner.y})<br>`;

                // QRコードの位置を描画
                ctx.strokeStyle = "#FF3B58";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
                ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
                ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
                ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
                ctx.lineTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
                ctx.stroke();
            } else {
                debugElement.innerHTML += "QRコード未検出<br>";
            }
        };
    </script>
</body>
</html>
