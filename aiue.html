<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>あいうえバトル（Firebase RTDB対応）</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: sans-serif; margin: 0; padding: 20px; }
    h2 { font-size: 1.2em; margin-bottom: 0.5em; }
    form, #entries, #kana-grid, #nav-buttons { margin-bottom: 1.5em; }
    input, button {
      padding: 0.5em;
      font-size: 1em;
      width: 100%;
      display: block;
    }
    #kana-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 2px 8px;
      max-width: 100%;
    }
    .card-btn {
      width: 42px; height: 42px;
      background: #fff;
      border: 2px solid #888;
      border-radius: 6px;
      font-size: 1.2em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .flipped { background: #4caf50; color: white; }
    .not-found { background: #ccc !important; color: #666 !important; }
    #resetBtn {
      background: red; color: white;
      padding: 0.5em 1em; border: none; border-radius: 4px;
      font-size: 1em; cursor: pointer;
    }
    #error { color: red; margin-top: 0.5em; }
    #word-input { max-width: 400px; margin: 0 auto; padding: 0 10px; }
    #form-setup { width: 100%; }
    @media (max-width: 600px) {
      body { padding: 10px; }
      input, button { width: 100%; margin-bottom: 0.5em; }
    }
  </style>
</head>
<body>
  <div id="word-input">
    <h2>プレイヤー設定</h2>
    <form id="form-setup">
      <input id="name" placeholder="プレイヤー名" required />
      <input id="chars" placeholder="最大7文字（あ-ん、ー）" maxlength="7" required />
      <button type="submit">登録</button>
      <div id="error"></div>
    </form>
    <div id="nav-buttons">
      <button id="to-kana">→ ひらがな選択へ</button>
    </div>
  </div>

  <div id="kana-select" style="display:none">
    <h2>エントリー状況</h2>
    <div id="entries"></div>

    <h2>50音表 + 「ー」</h2>
    <div id="kana-grid"></div>

    <button id="resetBtn">全体リセット</button>
    <div id="nav-buttons">
      <button id="to-word">← ワード入力へ戻る</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9336L3i6TzZAEiox0Up8zJEL6yAbxNwo",
      authDomain: "aiue-4a249.firebaseapp.com",
      projectId: "aiue-4a249",
      storageBucket: "aiue-4a249.firebasestorage.app",
      messagingSenderId: "490396478753",
      appId: "1:490396478753:web:99e3537394e2c5b3b36260"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const kanaList = [..."あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをんー"];
    const lineBreakAfter = ["お", "こ", "そ", "と", "の", "ほ", "も", "よ", "ろ", "ん"];
    const validCharRegex = /^[ぁ-んー]{1,7}$/;

    const kanaGrid = document.getElementById("kana-grid");
    const entriesDiv = document.getElementById("entries");
    const wordInputDiv = document.getElementById("word-input");
    const kanaSelectDiv = document.getElementById("kana-select");
    const form = document.getElementById("form-setup");
    const nameInput = document.getElementById("name");
    const charsInput = document.getElementById("chars");
    const errorDiv = document.getElementById("error");

    // ボタン生成
    kanaList.forEach((kana) => {
      const btn = document.createElement("button");
      btn.className = "card-btn";
      btn.textContent = kana;
      btn.addEventListener("click", () => {
        set(ref(db, 'revealed/' + kana), true);
      });
      kanaGrid.appendChild(btn);

      if (lineBreakAfter.includes(kana)) {
        const br = document.createElement("div");
        br.style.flexBasis = "100%";
        br.style.height = "0";
        kanaGrid.appendChild(br);
      }
    });

    // 不正文字のチェック関数
    const isAllValidKana = (input) => {
      const invalidChars = [...input].filter(ch => !kanaList.includes(ch));
      return {
        isValid: invalidChars.length === 0,
        invalidChars
      };
    };

    // 入力リアルタイム検証
    charsInput.addEventListener("input", () => {
      const input = charsInput.value.trim();
      const { isValid, invalidChars } = isAllValidKana(input);

      if (input && !isValid) {
        const messages = invalidChars.map(ch => `「${ch}」は使用できません`);
        errorDiv.innerHTML = messages.join("<br>");
      } else {
        errorDiv.textContent = "";
      }
    });

    // フォーム送信処理
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = nameInput.value.trim();
      const chars = charsInput.value.trim();
      const { isValid, invalidChars } = isAllValidKana(chars);

      if (!name) {
        errorDiv.textContent = "名前を入力してください";
        return;
      }

      if (!validCharRegex.test(chars) || !isValid) {
        const baseMsg = "使用できるのは「あ〜ん」と「ー」のみ（小さい文字・カタカナ・濁点などは不可）";
        const detail = invalidChars.length > 0 ? "<br>" + invalidChars.map(ch => `「${ch}」は使用できません`).join("<br>") : "";
        errorDiv.innerHTML = baseMsg + detail;
        return;
      }

      set(ref(db, 'players/' + name), chars);
      nameInput.value = "";
      charsInput.value = "";
      errorDiv.textContent = "";
      switchToKana();
    });

    // 表示切替
    document.getElementById("to-kana").addEventListener("click", switchToKana);
    document.getElementById("to-word").addEventListener("click", () => {
      wordInputDiv.style.display = "block";
      kanaSelectDiv.style.display = "none";
    });

    function switchToKana() {
      wordInputDiv.style.display = "none";
      kanaSelectDiv.style.display = "block";
    }

    // RTDB監視
    onValue(ref(db, 'players'), (snapshot) => {
      const players = snapshot.val() || {};
      renderEntries(players);
    });

    onValue(ref(db, 'revealed'), (snapshot) => {
      const revealed = snapshot.val() || {};
      document.querySelectorAll(".card-btn").forEach(btn => {
        const kana = btn.textContent;
        btn.classList.remove("flipped", "not-found");
        if (revealed[kana]) {
          btn.classList.add("flipped");
        }
      });

      onValue(ref(db, 'players'), (snap) => {
        const players = snap.val() || {};
        document.querySelectorAll(".card-btn").forEach(btn => {
          const kana = btn.textContent;
          const isUsed = Object.values(players).some(word => word.includes(kana));
          if (revealed[kana] && !isUsed) {
            btn.classList.add("not-found");
          }
        });
      });
    });

    // リセット
document.getElementById("resetBtn").addEventListener("click", () => {
  const confirmed = confirm("すべてのプレイヤー情報と公開文字を削除します。\n本当にリセットしてもよろしいですか？");

  if (confirmed) {
    remove(ref(db, "revealed"));
    remove(ref(db, "players"));
    document.querySelectorAll(".card-btn").forEach(btn => {
    btn.classList.remove("flipped", "not-found");
  }
});

    // エントリー描画
    function renderEntries(players) {
      onValue(ref(db, 'revealed'), (snapshot) => {
        const revealed = snapshot.val() || {};
        const revealedKana = new Set(Object.keys(revealed));
        entriesDiv.innerHTML = "";
        for (const player in players) {
          const div = document.createElement("div");
          div.innerHTML = `<strong>${player}</strong>: ` +
            [...players[player]].map(ch => revealedKana.has(ch) ? ch : "●").join("");
          entriesDiv.appendChild(div);
        }
      });
    }
  </script>
</body>
</html>
