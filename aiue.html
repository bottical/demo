<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>あいうえバトル（匿名・50音・リセット対応）</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; }
    h2 { font-size: 1.2em; margin-bottom: 0.5em; }
    form, #entries, #kana-grid, #nav-buttons { margin-bottom: 1.5em; }
    input, button { padding: 0.5em; font-size: 1em; }
    #kana-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-width: 100%;
    }
    .card-btn {
      width: 50px; height: 50px;
      background: #fff;
      border: 2px solid #888;
      border-radius: 6px;
      font-size: 1.2em;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .flipped {
      background: #4caf50; color: white;
    }
    .not-found {
      background: #ccc !important; color: #666 !important;
    }
    #resetBtn {
      background: red; color: white;
      padding: 0.5em 1em; border: none; border-radius: 4px;
      font-size: 1em; cursor: pointer;
    }
    #error { color: red; margin-top: 0.5em; }
    @media (max-width: 600px) {
      input, button { width: 100%; margin-bottom: 0.5em; }
    }
  </style>
</head>
<body>
  <div id="word-input">
    <h2>プレイヤー設定</h2>
    <form id="form-setup">
      <input id="name" placeholder="プレイヤー名" required />
      <input id="chars" placeholder="最大7文字（あ-ん、ー）" maxlength="7" required />
      <button type="submit">登録</button>
      <div id="error"></div>
    </form>
    <div id="nav-buttons">
      <button id="to-kana">→ ひらがな選択へ</button>
    </div>
  </div>

  <div id="kana-select" style="display:none">
    <h2>エントリー状況</h2>
    <div id="entries"></div>

    <h2>50音表 + 「ー」</h2>
    <div id="kana-grid"></div>

    <button id="resetBtn">全体リセット</button>
    <div id="nav-buttons">
      <button id="to-word">← ワード入力へ戻る</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
    apiKey: "AIzaSyA9336L3i6TzZAEiox0Up8zJEL6yAbxNwo",
    authDomain: "aiue-4a249.firebaseapp.com",
    projectId: "aiue-4a249",
    storageBucket: "aiue-4a249.firebasestorage.app",
    messagingSenderId: "490396478753",
    appId: "1:490396478753:web:99e3537394e2c5b3b36260"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const kana = [..."あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをんー"];

    let flipsState = {};
    let notFoundChars = new Set();

    document.getElementById("form-setup").onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const chars = document.getElementById("chars").value.trim();
      const errorEl = document.getElementById("error");
      if (!/^[あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをんー]{1,7}$/.test(chars)) {
        errorEl.textContent = "※ 有効な50音＋ーのみ、最大7文字で入力してください（濁点・半濁点・小文字は不可）。";
        return;
      }
      errorEl.textContent = "";
      await set(ref(db, `entries/${name}`), chars.split(""));
      document.getElementById("word-input").style.display = "none";
      document.getElementById("kana-select").style.display = "block";
    };

    const grid = document.getElementById("kana-grid");
    kana.forEach((c, i) => {
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.className = "card-btn";
      btn.onclick = async () => {
        if (btn.classList.contains("not-found")) return;
        const snap = await get(ref(db, "entries"));
        let matched = false;
        snap.forEach(s => {
          if ((s.val() || []).includes(c)) matched = true;
        });
        if (matched) {
          await set(ref(db, `flips/${c}`), true);
        } else {
          btn.classList.add("not-found");
          notFoundChars.add(c);
        }
      };
      grid.appendChild(btn);
      if ((i + 1) % 5 === 0) {
        const br = document.createElement("div");
        br.style.flexBasis = "100%";
        grid.appendChild(br);
      }
    });

    function updateEntries() {
      get(ref(db, "entries")).then(snap => {
        const el = document.getElementById("entries");
        el.innerHTML = "";
        snap.forEach(s => {
          const name = s.key;
          const arr = s.val() || [];
          const masked = arr.map(c => flipsState[c] ? c : "●").join("");
          el.innerHTML += `<div>${name}: ${masked}</div>`;
        });
      });
    }

    onValue(ref(db, "flips"), snap => {
      flipsState = snap.val() || {};
      document.querySelectorAll(".card-btn").forEach(btn => {
        const char = btn.textContent;
        btn.classList.toggle("flipped", !!flipsState[char]);
        if (notFoundChars.has(char)) btn.classList.add("not-found");
      });
      updateEntries();
    });
    onValue(ref(db, "entries"), updateEntries);

    document.getElementById("resetBtn").onclick = async () => {
      if (confirm("すべてのデータを削除しますか？")) {
        await set(ref(db, "entries"), null);
        await set(ref(db, "flips"), null);
        notFoundChars.clear();
        document.querySelectorAll(".card-btn").forEach(btn => {
          btn.classList.remove("not-found", "flipped");
        });
      }
    };

    document.getElementById("to-kana").onclick = () => {
      document.getElementById("word-input").style.display = "none";
      document.getElementById("kana-select").style.display = "block";
    };
    document.getElementById("to-word").onclick = () => {
      document.getElementById("kana-select").style.display = "none";
      document.getElementById("word-input").style.display = "block";
    };
  </script>
</body>
</html>
