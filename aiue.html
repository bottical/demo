<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚ã„ã†ãˆãƒãƒˆãƒ«ï¼ˆåŒ¿åãƒ»50éŸ³ãƒ»ãƒªã‚»ãƒƒãƒˆå¯¾å¿œï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #kana-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-width: 400px; margin-top: 16px; }
    .card-btn {
      width: 60px; height: 60px;
      background: #fff;
      border: 2px solid #888;
      border-radius: 6px;
      font-size: 24px;
      cursor: pointer;
      perspective: 400px;
    }
    .card-inner {
      width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    .flipped .card-inner {
      transform: rotateY(180deg);
      background-color: #4caf50;
      color: white;
    }
    #resetBtn {
      margin-top: 20px;
      background: red;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="setup">
    <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š</h2>
    <form id="form-setup">
      <input id="name" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" required />
      <input id="chars" placeholder="æœ€å¤§7æ–‡å­—ï¼ˆã‚-ã‚“ã€ãƒ¼å«ã‚€ï¼‰" maxlength="7" pattern="[ã-ã‚“ãƒ¼]{1,7}" required />
      <button type="submit">é–‹å§‹ã™ã‚‹</button>
    </form>
  </div>

  <div id="game" style="display:none">
    <h2>ã‚¨ãƒ³ãƒˆãƒªãƒ¼çŠ¶æ³ï¼ˆä¼ã›ã‚‰ã‚ŒãŸæ–‡å­—ï¼‰</h2>
    <div id="entries"></div>

    <h2>50éŸ³è¡¨ + ã€Œãƒ¼ã€</h2>
    <div id="kana-grid"></div>

    <button id="resetBtn">å…¨ä½“ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ğŸ”§ ã‚ãªãŸã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„
    const firebaseConfig = {
    apiKey: "AIzaSyA9336L3i6TzZAEiox0Up8zJEL6yAbxNwo",
    authDomain: "aiue-4a249.firebaseapp.com",
    projectId: "aiue-4a249",
    storageBucket: "aiue-4a249.firebasestorage.app",
    messagingSenderId: "490396478753",
    appId: "1:490396478753:web:99e3537394e2c5b3b36260"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const setupForm = document.getElementById("form-setup");
    const kana = [
      "ã‚","ã„","ã†","ãˆ","ãŠ",
      "ã‹","ã","ã","ã‘","ã“",
      "ã•","ã—","ã™","ã›","ã",
      "ãŸ","ã¡","ã¤","ã¦","ã¨",
      "ãª","ã«","ã¬","ã­","ã®",
      "ã¯","ã²","ãµ","ã¸","ã»",
      "ã¾","ã¿","ã‚€","ã‚","ã‚‚",
      "ã‚„","ã‚†","ã‚ˆ",
      "ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚",
      "ã‚","ã‚’","ã‚“","ãƒ¼"
    ];

    let flipsState = {};

    setupForm.onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const chars = document.getElementById("chars").value.trim().split("");
      await set(ref(db, `entries/${name}`), chars);
      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "";
    };

    const grid = document.getElementById("kana-grid");
    kana.forEach(c => {
      const btn = document.createElement("button");
      btn.innerHTML = `<div class="card-inner">${c}</div>`;
      btn.className = "card-btn";
      btn.onclick = async () => {
        const snap = await get(ref(db, "entries"));
        const matched = [];
        snap.forEach(s => {
          const arr = s.val();
          if (arr?.includes(c)) matched.push(s.key);
        });
        if (matched.length > 0) {
          await set(ref(db, `flips/${c}`), true);
        }
      };
      grid.appendChild(btn);
    });

    onValue(ref(db, "flips"), snap => {
      flipsState = snap.val() || {};
      document.querySelectorAll(".card-btn").forEach(btn => {
        const inner = btn.querySelector(".card-inner");
        if (inner && flipsState[inner.textContent]) {
          btn.classList.add("flipped");
        } else {
          btn.classList.remove("flipped");
        }
      });
      // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ entries è¡¨ç¤º
      updateMaskedEntries();
    });

    onValue(ref(db, "entries"), () => {
      updateMaskedEntries();
    });

    async function updateMaskedEntries() {
      const snap = await get(ref(db, "entries"));
      const el = document.getElementById("entries");
      el.innerHTML = "";
      snap.forEach(s => {
        const name = s.key;
        const arr = s.val() || [];
        const masked = arr.map(c => flipsState[c] ? c : "â—").join("");
        el.innerHTML += `<div>${name}: ${masked}</div>`;
      });
    }

    document.getElementById("resetBtn").onclick = async () => {
      if (confirm("æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        await set(ref(db, "entries"), null);
        await set(ref(db, "flips"), null);
      }
    };
  </script>
</body>
</html>
