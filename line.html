<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LINE txt â†’ è¨ºæ–­PDFï¼ˆè§£æå¿…é ˆãƒ»GPTå›ºå®šï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --border:#1f2937;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif; background:var(--bg); color:var(--ink); }
    .wrap{ max-width:980px; margin:0 auto; padding:22px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; }
    h1{ margin:0 0 10px; font-size:18px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:820px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:12px 0 6px; }
    input, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0b1020; color:var(--ink); outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:rgba(96,165,250,.18); color:var(--ink); cursor:pointer; font-weight:700;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .hint{ color:var(--muted); font-size:12px; line-height:1.55; margin-top:10px; }
    .log{ white-space:pre-wrap; background:#050814; border:1px solid var(--border); border-radius:12px; padding:10px; margin-top:12px; font-size:12px; color:#cbd5e1; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>LINEå±¥æ­´ï¼ˆ.txtï¼‰â†’ è¨ºæ–­PDFï¼ˆè§£æå¿…é ˆ / GPTå›ºå®šï¼‰</h1>

      <div class="row">
        <div>
          <label>1) LINEå±¥æ­´ .txt ã‚’é¸æŠ</label>
          <input id="file" type="file" accept=".txt,text/plain" />
        </div>
        <div>
          <label>2) Cloudflare Worker URLï¼ˆ/generateï¼‰</label>
          <input id="workerUrl" type="url" placeholder="https://xxx.workers.dev/generate" />
        </div>
      </div>

      <label>è£œè¶³ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="notes" placeholder="ä¾‹ï¼šäº¤éš›å‰ã¾ã§ã‚’å¯¾è±¡ã€‚æ–­å®šã¯é¿ã‘ã€æ¬¡ã®ä¸€æ–‡æ¡ˆã¯å¿…ãš2ç¨®é¡ï¼ˆå®‰å…¨/è¸ã¿è¾¼ã‚€ï¼‰ã§ã€‚"></textarea>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="runBtn">PDFã‚’ç”Ÿæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="btn" id="sampleBtn" type="button">ã‚µãƒ³ãƒ—ãƒ«ã§è©¦ã™</button>
        <div class="pill">âœ… è§£æå¿…é ˆ / GPTå›ºå®š / APIã‚­ãƒ¼ä¸è¦</div>
      </div>

      <div class="hint">
        - æœ¬ãƒ„ãƒ¼ãƒ«ã¯<strong>å¿…ãšè§£æã‚’è¡Œã„ã¾ã™</strong>ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã®ã¿ã®PDFã¯ç”Ÿæˆã—ã¾ã›ã‚“ï¼‰<br>
        - è§£æã«ã¯ GPT ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯å›ºå®šï¼‰<br>
        - Worker URL ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«è¨˜æ†¶ã•ã‚Œã¾ã™
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (s) => { $("log").textContent = String(s ?? ""); };

    const LLM_ENDPOINT = "https://api.openai.com/v1/chat/completions";
    const MODEL = "gpt-4.1-mini";
    const STORAGE_KEY = "line_report_worker_url";

    function saveWorkerUrl(url){
      localStorage.setItem(STORAGE_KEY, url);
    }
    function loadWorkerUrl(){
      return localStorage.getItem(STORAGE_KEY) || "";
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    function nowStamp(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }

    async function runWithText(text){
      const workerUrl = $("workerUrl").value.trim();
      if(!workerUrl) throw new Error("Worker URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      saveWorkerUrl(workerUrl);

      // ãƒã‚¤ã‚ºæœ€ä½é™åœ§ç¸®
      const cleaned = text
        .replace(/\[(å†™çœŸ|ã‚¹ã‚¿ãƒ³ãƒ—|ãƒ•ã‚¡ã‚¤ãƒ«|é€šè©±|å‹•ç”»)\].*/g, "[ãƒ¡ãƒ‡ã‚£ã‚¢]")
        .replace(/\n{3,}/g, "\n\n");

      const payload = {
        mode: "analyze_and_pdf",
        llmEndpoint: LLM_ENDPOINT,
        model: MODEL,
        notes: $("notes").value.trim() || null,
        lineText: cleaned
      };

      log("è§£æãƒ»PDFç”Ÿæˆä¸­â€¦");
      $("runBtn").disabled = true;

      const res = await fetch(workerUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const msg = await res.text().catch(()=>"(no body)");
        throw new Error(`Worker error: ${res.status}\n${msg}`);
      }

      const ct = res.headers.get("content-type") || "";
      if(!ct.includes("application/pdf")){
        const msg = await res.text().catch(()=>"(no body)");
        throw new Error(`PDFã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™: ${ct}\n${msg}`);
      }

      const blob = await res.blob();
      downloadBlob(blob, `line_report_${nowStamp()}.pdf`);
      log("å®Œäº†ï¼šPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
    }

    $("runBtn").addEventListener("click", async ()=>{
      try{
        const f = $("file").files?.[0];
        if(!f) throw new Error(".txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        const text = await f.text();
        await runWithText(text);
      }catch(e){
        log(e?.message || e);
      }finally{
        $("runBtn").disabled = false;
      }
    });

    $("sampleBtn").addEventListener("click", async ()=>{
      try{
        const sample = [
          "2025/12/01(æœˆ)",
          "20:01 A: ä»Šæ—¥ã¯ã‚ã‚ŠãŒã¨ã†ï¼ã‚ã¡ã‚ƒæ¥½ã—ã‹ã£ãŸ",
          "20:02 B: ã“ã¡ã‚‰ã“ãğŸ˜Šã¾ãŸä¼šã„ãŸã„ãª",
          "20:05 A: æ¬¡ã„ã¤ç©ºã„ã¦ã‚‹ï¼Ÿ",
          "20:06 B: é€±æœ«ãªã‚‰ç©ºã„ã¦ã‚‹ï¼",
          "2025/12/02(ç«)",
          "09:10 A: æ˜¨æ—¥ã‚‚æ€ã£ãŸã‘ã©ä¸€ç·’ã«ã„ã‚‹ã¨è½ã¡ç€ãã­",
          "09:12 B: å¬‰ã—ã„â˜ºï¸ ç§ã‚‚ã ã‚ˆ"
        ].join("\n");
        await runWithText(sample);
      }catch(e){
        log(e?.message || e);
      }
    });

    // åˆæœŸåŒ–ï¼šWorker URL å¾©å…ƒ
    window.addEventListener("DOMContentLoaded", ()=>{
      $("workerUrl").value = loadWorkerUrl();
    });
  </script>
</body>
</html>
